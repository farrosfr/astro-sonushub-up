---
import Layout from '../layouts/Layout.astro';
---
<Layout title="Mulai - SonusHUB Updater">
  <style>
    .hgroup-wrapper {
      text-align: center;
      margin-bottom: 2.5rem;
    }
    .form-wrapper {
      max-width: 550px;
      margin: 0 auto;
    }
    .form-wrapper label {
      font-weight: 500;
    }
    .form-wrapper small {
      display: block;
      margin-top: 0.25rem;
      opacity: 0.9;
    }
    .form-wrapper button {
      width: 100%;
      padding: 0.85rem;
      font-weight: 500;
    }
    .file-input-wrapper {
      border: 2px dashed var(--form-element-border-color);
      border-radius: var(--border-radius);
      padding: 2rem;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.2s ease, background-color 0.2s ease;
    }
    .file-input-wrapper:hover {
      border-color: var(--primary);
      background-color: var(--form-element-background-color);
    }
    .file-input-wrapper input[type="file"] {
      display: none;
    }
    .ai-toggle {
        margin-top: 1.5rem;
    }
  </style>

  <div class="form-wrapper">
    <div class="hgroup-wrapper">
        <hgroup>
            <h2>ðŸš€ Mulai Proses Pembaruan</h2>
            <p>Unggah file CSV Anda untuk memulai pembaruan harga produk secara massal.</p>
        </hgroup>
    </div>

    <article>
      <form action="/konfirmasi" method="post" enctype="multipart/form-data">
        
        <label for="fileCsv" class="file-input-wrapper" id="file-drop-zone">
            <strong>Klik untuk memilih file atau jatuhkan file di sini</strong>
            <small>Hanya file .csv yang diterima</small>
            <input type="file" name="fileCsv" id="fileCsv" accept=".csv" required>
        </label>
        <small id="file-name-display" style="text-align: center; margin-top: 1rem;"></small>

        <fieldset class="ai-toggle">
          <label for="gunakan_ai">
            <input type="checkbox" id="gunakan_ai" name="gunakan_ai" value="yes" role="switch">
            Gunakan Validasi AI untuk saran dan analisis
          </label>
        </fieldset>

        <button type="submit" name="submit">
            Proses & Lanjutkan â†’
        </button>
      </form>
    </article>

    <article>
        <hgroup>
            <h4>Unduh Data</h4>
            <p>Gunakan template untuk format unggah yang benar atau unduh daftar produk untuk melihat ID yang ada.</p>
        </hgroup>
        <div class="grid">
            <a href="#" id="download-template" role="button" class="secondary outline">Unduh Template Kosong</a>
            <a href="/api/export-products" role="button" class="secondary outline">Unduh Daftar Produk</a>
        </div>
    </article>
  </div>

  <script>
    const fileInput = document.getElementById('fileCsv') as HTMLInputElement;
    const dropZone = document.getElementById('file-drop-zone') as HTMLLabelElement;
    const fileNameDisplay = document.getElementById('file-name-display') as HTMLElement;

    if (fileInput && dropZone && fileNameDisplay) {
        fileInput.addEventListener('change', () => {
            if (fileInput.files && fileInput.files.length > 0) {
                fileNameDisplay.textContent = `File dipilih: ${fileInput.files[0].name}`;
            } else {
                fileNameDisplay.textContent = '';
            }
        });

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = 'var(--primary)';
        });

        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = 'var(--form-element-border-color)';
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = 'var(--form-element-border-color)';
            if (e.dataTransfer && e.dataTransfer.files.length > 0) {
                const dataTransfer = new DataTransfer();
                const csvFile = Array.from(e.dataTransfer.files).find(
                    file => file.name.toLowerCase().endsWith('.csv')
                );

                if (csvFile) {
                    dataTransfer.items.add(csvFile);
                    fileInput.files = dataTransfer.files;
                    const changeEvent = new Event('change');
                    fileInput.dispatchEvent(changeEvent);
                } else {
                    alert('Hanya file .csv yang diterima.');
                    fileInput.value = '';
                    fileNameDisplay.textContent = '';
                }
            }
        });
    }

    // --- Download Template Script ---
    const downloadBtn = document.getElementById('download-template');
    if (downloadBtn) {
        downloadBtn.addEventListener('click', () => {
            const headers = 'id_produk,harga_baru,stock,unit,min_qty';
            const blob = new Blob([headers], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'template_update_produk.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
    }
  </script>
</Layout>